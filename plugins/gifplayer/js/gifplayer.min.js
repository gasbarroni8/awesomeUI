!function(root,factory){"function"==typeof define&&define.amd?define([],factory):"object"==typeof exports?module.exports=factory():root.SuperGif=factory()}(this,function(){var bitsToNum=function(ba){return ba.reduce(function(s,n){return 2*s+n},0)},byteToBitArr=function(bite){for(var a=[],i=7;i>=0;i--)a.push(!!(bite&1<<i));return a},Stream=function(data){this.data=data,this.len=this.data.length,this.pos=0,this.readByte=function(){if(this.pos>=this.data.length)throw new Error("Attempted to read past end of stream.");return data instanceof Uint8Array?data[this.pos++]:255&data.charCodeAt(this.pos++)},this.readBytes=function(n){for(var bytes=[],i=0;i<n;i++)bytes.push(this.readByte());return bytes},this.read=function(n){for(var s="",i=0;i<n;i++)s+=String.fromCharCode(this.readByte());return s},this.readUnsigned=function(){var a=this.readBytes(2);return(a[1]<<8)+a[0]}},parseGIF=function(st,handler){handler||(handler={});var parseCT=function(entries){for(var ct=[],i=0;i<entries;i++)ct.push(st.readBytes(3));return ct},readSubBlocks=function(){var size,data;data="";do{size=st.readByte(),data+=st.read(size)}while(0!==size);return data},parseImg=function(img){img.leftPos=st.readUnsigned(),img.topPos=st.readUnsigned(),img.width=st.readUnsigned(),img.height=st.readUnsigned();var bits=byteToBitArr(st.readByte());img.lctFlag=bits.shift(),img.interlaced=bits.shift(),img.sorted=bits.shift(),img.reserved=bits.splice(0,2),img.lctSize=bitsToNum(bits.splice(0,3)),img.lctFlag&&(img.lct=parseCT(1<<img.lctSize+1)),img.lzwMinCodeSize=st.readByte();var lzwData=readSubBlocks();img.pixels=function(minCodeSize,data){for(var code,last,pos=0,readCode=function(size){for(var code=0,i=0;i<size;i++)data.charCodeAt(pos>>3)&1<<(7&pos)&&(code|=1<<i),pos++;return code},output=[],clearCode=1<<minCodeSize,eoiCode=clearCode+1,codeSize=minCodeSize+1,dict=[],clear=function(){dict=[],codeSize=minCodeSize+1;for(var i=0;i<clearCode;i++)dict[i]=[i];dict[clearCode]=[],dict[eoiCode]=null};;)if(last=code,(code=readCode(codeSize))!==clearCode){if(code===eoiCode)break;if(code<dict.length)last!==clearCode&&dict.push(dict[last].concat(dict[code][0]));else{if(code!==dict.length)throw new Error("Invalid LZW code.");dict.push(dict[last].concat(dict[last][0]))}output.push.apply(output,dict[code]),dict.length===1<<codeSize&&codeSize<12&&codeSize++}else clear();return output}(img.lzwMinCodeSize,lzwData),img.interlaced&&(img.pixels=function(pixels,width){for(var newPixels=new Array(pixels.length),rows=pixels.length/width,cpRow=function(toRow,fromRow){var fromPixels=pixels.slice(fromRow*width,(fromRow+1)*width);newPixels.splice.apply(newPixels,[toRow*width,width].concat(fromPixels))},offsets=[0,4,2,1],steps=[8,8,4,2],fromRow=0,pass=0;pass<4;pass++)for(var toRow=offsets[pass];toRow<rows;toRow+=steps[pass])cpRow(toRow,fromRow),fromRow++;return newPixels}(img.pixels,img.width)),handler.img&&handler.img(img)},parseBlock=function(){var block={};switch(block.sentinel=st.readByte(),String.fromCharCode(block.sentinel)){case"!":block.type="ext",function(block){switch(block.label=st.readByte(),block.label){case 249:block.extType="gce",function(block){st.readByte();var bits=byteToBitArr(st.readByte());block.reserved=bits.splice(0,3),block.disposalMethod=bitsToNum(bits.splice(0,3)),block.userInput=bits.shift(),block.transparencyGiven=bits.shift(),block.delayTime=st.readUnsigned(),block.transparencyIndex=st.readByte(),block.terminator=st.readByte(),handler.gce&&handler.gce(block)}(block);break;case 254:block.extType="com",function(block){block.comment=readSubBlocks(),handler.com&&handler.com(block)}(block);break;case 1:block.extType="pte",function(block){st.readByte(),block.ptHeader=st.readBytes(12),block.ptData=readSubBlocks(),handler.pte&&handler.pte(block)}(block);break;case 255:block.extType="app",function(block){switch(st.readByte(),block.identifier=st.read(8),block.authCode=st.read(3),block.identifier){case"NETSCAPE":!function(block){st.readByte(),block.unknown=st.readByte(),block.iterations=st.readUnsigned(),block.terminator=st.readByte(),handler.app&&handler.app.NETSCAPE&&handler.app.NETSCAPE(block)}(block);break;default:!function(block){block.appData=readSubBlocks(),handler.app&&handler.app[block.identifier]&&handler.app[block.identifier](block)}(block)}}(block);break;default:block.extType="unknown",function(block){block.data=readSubBlocks(),handler.unknown&&handler.unknown(block)}(block)}}(block);break;case",":block.type="img",parseImg(block);break;case";":block.type="eof",handler.eof&&handler.eof(block);break;default:throw new Error("Unknown block: 0x"+block.sentinel.toString(16))}"eof"!==block.type&&setTimeout(parseBlock,0)};!function(){var hdr={};if(hdr.sig=st.read(3),hdr.ver=st.read(3),"GIF"!==hdr.sig)throw new Error("Not a GIF file.");hdr.width=st.readUnsigned(),hdr.height=st.readUnsigned();var bits=byteToBitArr(st.readByte());hdr.gctFlag=bits.shift(),hdr.colorRes=bitsToNum(bits.splice(0,3)),hdr.sorted=bits.shift(),hdr.gctSize=bitsToNum(bits.splice(0,3)),hdr.bgColor=st.readByte(),hdr.pixelAspectRatio=st.readByte(),hdr.gctFlag&&(hdr.gct=parseCT(1<<hdr.gctSize+1)),handler.hdr&&handler.hdr(hdr)}(),setTimeout(parseBlock,0)};return function(opts){var stream,hdr,options={vp_l:0,vp_t:0,vp_w:null,vp_h:null,c_w:null,c_h:null};for(var i in opts)options[i]=opts[i];options.vp_w&&options.vp_h&&(options.is_vp=!0);var loadError=null,loading=!1,transparency=null,delay=null,disposalMethod=null,disposalRestoreFromIdx=null,lastDisposalMethod=null,frame=null,lastImg=null,playing=!0,ctx_scaled=!1,frames=[],frameOffsets=[],gif=options.gif;void 0===options.auto_play&&(options.auto_play=!gif.getAttribute("rel:auto_play")||"1"==gif.getAttribute("rel:auto_play"));var canvas,ctx,toolbar,tmpCanvas,onEndListener=options.hasOwnProperty("on_end")?options.on_end:null,loopDelay=options.hasOwnProperty("loop_delay")?options.loop_delay:0,overrideLoopMode=options.hasOwnProperty("loop_mode")?options.loop_mode:"auto",drawWhileLoading=!options.hasOwnProperty("draw_while_loading")||options.draw_while_loading,showProgressBar=!!drawWhileLoading&&(!options.hasOwnProperty("show_progress_bar")||options.show_progress_bar),progressBarHeight=options.hasOwnProperty("progressbar_height")?options.progressbar_height:25,progressBarBackgroundColor=options.hasOwnProperty("progressbar_background_color")?options.progressbar_background_color:"rgba(255,255,255,0.4)",progressBarForegroundColor=options.hasOwnProperty("progressbar_foreground_color")?options.progressbar_foreground_color:"rgba(255,0,22,.8)",clear=function(){transparency=null,delay=null,lastDisposalMethod=disposalMethod,disposalMethod=null,frame=null},doParse=function(){try{parseGIF(stream,handler)}catch(err){doLoadError("parse")}},setSizes=function(w,h){canvas.width=w*get_canvas_scale(),canvas.height=h*get_canvas_scale(),toolbar.style.minWidth=w*get_canvas_scale()+"px",tmpCanvas.width=w,tmpCanvas.height=h,tmpCanvas.style.width=w+"px",tmpCanvas.style.height=h+"px",tmpCanvas.getContext("2d").setTransform(1,0,0,1,0,0)},doShowProgress=function(pos,length,draw){if(draw&&showProgressBar){var mid,top,width,height=progressBarHeight;options.is_vp?ctx_scaled?(top=(options.vp_t+options.vp_h-height)/get_canvas_scale(),height/=get_canvas_scale(),mid=options.vp_l/get_canvas_scale()+pos/length*(options.vp_w/get_canvas_scale()),width=canvas.width/get_canvas_scale()):(top=options.vp_t+options.vp_h-height,height=height,mid=options.vp_l+pos/length*options.vp_w,width=canvas.width):(top=(canvas.height-height)/(ctx_scaled?get_canvas_scale():1),mid=pos/length*canvas.width/(ctx_scaled?get_canvas_scale():1),width=canvas.width/(ctx_scaled?get_canvas_scale():1),height/=ctx_scaled?get_canvas_scale():1),ctx.fillStyle=progressBarBackgroundColor,ctx.fillRect(mid,top,width-mid,height),ctx.fillStyle=progressBarForegroundColor,ctx.fillRect(0,top,mid,height)}},doLoadError=function(originOfError){loadError=originOfError,hdr={width:gif.width,height:gif.height},frames=[],ctx.fillStyle="black",ctx.fillRect(0,0,options.c_w?options.c_w:hdr.width,options.c_h?options.c_h:hdr.height),ctx.strokeStyle="red",ctx.lineWidth=3,ctx.moveTo(0,0),ctx.lineTo(options.c_w?options.c_w:hdr.width,options.c_h?options.c_h:hdr.height),ctx.moveTo(0,options.c_h?options.c_h:hdr.height),ctx.lineTo(options.c_w?options.c_w:hdr.width,0),ctx.stroke()},pushFrame=function(){frame&&(frames.push({data:frame.getImageData(0,0,hdr.width,hdr.height),delay:delay}),frameOffsets.push({x:0,y:0}))},player=function(){var stepping,completeLoop,doStep,i=-1,iterationCount=0,stepFrame=function(amount){i+=amount,putFrame()},step=(stepping=!1,completeLoop=function(){null!==onEndListener&&onEndListener(gif),!1!==overrideLoopMode||++iterationCount<0?doStep():(stepping=!1,playing=!1)},doStep=function(){if(stepping=playing){stepFrame(1);var delay=10*frames[i].delay;delay||(delay=100),0==(i+1+frames.length)%frames.length?(delay+=loopDelay,setTimeout(completeLoop,delay)):setTimeout(doStep,delay)}},function(){stepping||setTimeout(doStep,0)}),putFrame=function(){var offset;(i=parseInt(i,10))>frames.length-1&&(i=0),i<0&&(i=0),offset=frameOffsets[i],tmpCanvas.getContext("2d").putImageData(frames[i].data,offset.x,offset.y),ctx.globalCompositeOperation="copy",ctx.drawImage(tmpCanvas,0,0)};return{init:function(){loadError||(options.c_w&&options.c_h||ctx.scale(get_canvas_scale(),get_canvas_scale()),options.auto_play?step():(i=0,putFrame()))},step:step,play:function(){playing=!0,step()},pause:function(){playing=!1},playing:playing,move_relative:stepFrame,current_frame:function(){return i},length:function(){return frames.length},move_to:function(frame_idx){i=frame_idx,putFrame()}}}(),doDecodeProgress=function(draw){doShowProgress(stream.pos,stream.data.length,draw)},doNothing=function(){},withProgress=function(fn,draw){return function(block){fn(block),doDecodeProgress(draw)}},handler={hdr:withProgress(function(_hdr){setSizes((hdr=_hdr).width,hdr.height)}),gce:withProgress(function(gce){pushFrame(),clear(),transparency=gce.transparencyGiven?gce.transparencyIndex:null,delay=gce.delayTime,disposalMethod=gce.disposalMethod}),com:withProgress(doNothing),app:{NETSCAPE:withProgress(doNothing)},img:withProgress(function(img){frame||(frame=tmpCanvas.getContext("2d"));var currIdx=frames.length,ct=img.lctFlag?img.lct:hdr.gct;currIdx>0&&(3===lastDisposalMethod?null!==disposalRestoreFromIdx?frame.putImageData(frames[disposalRestoreFromIdx].data,0,0):frame.clearRect(lastImg.leftPos,lastImg.topPos,lastImg.width,lastImg.height):disposalRestoreFromIdx=currIdx-1,2===lastDisposalMethod&&frame.clearRect(lastImg.leftPos,lastImg.topPos,lastImg.width,lastImg.height));var imgData=frame.getImageData(img.leftPos,img.topPos,img.width,img.height);img.pixels.forEach(function(pixel,i){pixel!==transparency&&(imgData.data[4*i+0]=ct[pixel][0],imgData.data[4*i+1]=ct[pixel][1],imgData.data[4*i+2]=ct[pixel][2],imgData.data[4*i+3]=255)}),frame.putImageData(imgData,img.leftPos,img.topPos),ctx_scaled||(ctx.scale(get_canvas_scale(),get_canvas_scale()),ctx_scaled=!0),drawWhileLoading&&(ctx.drawImage(tmpCanvas,0,0),drawWhileLoading=options.auto_play),lastImg=img},!0),eof:function(block){pushFrame(),doDecodeProgress(!1),options.c_w&&options.c_h||(canvas.width=hdr.width*get_canvas_scale(),canvas.height=hdr.height*get_canvas_scale()),player.init(),loading=!1,load_callback&&load_callback(gif)}},init=function(){var parent=gif.parentNode,div=document.createElement("div");canvas=document.createElement("canvas"),ctx=canvas.getContext("2d"),toolbar=document.createElement("div"),tmpCanvas=document.createElement("canvas"),div.width=canvas.width=gif.width,div.height=canvas.height=gif.height,toolbar.style.minWidth=gif.width+"px",div.className="jsgif",toolbar.className="jsgif_toolbar",div.appendChild(canvas),div.appendChild(toolbar),parent.insertBefore(div,gif),parent.removeChild(gif),options.c_w&&options.c_h&&setSizes(options.c_w,options.c_h),initialized=!0},get_canvas_scale=function(){return options.max_width&&hdr&&hdr.width>options.max_width?options.max_width/hdr.width:1},initialized=!1,load_callback=!1,load_setup=function(callback){return!loading&&(load_callback=callback||!1,loading=!0,frames=[],clear(),disposalRestoreFromIdx=null,lastDisposalMethod=null,frame=null,lastImg=null,!0)};return{play:player.play,pause:player.pause,move_relative:player.move_relative,move_to:player.move_to,get_playing:function(){return playing},get_canvas:function(){return canvas},get_canvas_scale:function(){return get_canvas_scale()},get_loading:function(){return loading},get_auto_play:function(){return options.auto_play},get_length:function(){return player.length()},get_current_frame:function(){return player.current_frame()},load_url:function(src,callback){if(load_setup(callback)){var h=new XMLHttpRequest;h.open("GET",src,!0),"overrideMimeType"in h?h.overrideMimeType("text/plain; charset=x-user-defined"):"responseType"in h?h.responseType="arraybuffer":h.setRequestHeader("Accept-Charset","x-user-defined"),h.onloadstart=function(){initialized||init()},h.onload=function(e){200!=this.status&&doLoadError("xhr - response"),"response"in this||(this.response=new VBArray(this.responseText).toArray().map(String.fromCharCode).join(""));var data=this.response;data.toString().indexOf("ArrayBuffer")>0&&(data=new Uint8Array(data)),stream=new Stream(data),setTimeout(doParse,0)},h.onprogress=function(e){e.lengthComputable&&doShowProgress(e.loaded,e.total,!0)},h.onerror=function(){doLoadError("xhr")},h.send()}},load:function(callback){this.load_url(gif.getAttribute("rel:animated_src")||gif.src||gif.getAttribute("data-src"),callback)},load_raw:function(arr,callback){load_setup(callback)&&(initialized||init(),stream=new Stream(arr),setTimeout(doParse,0))},set_frame_offset:function(frame,offset){frameOffsets[frame]?(void 0!==offset.x&&(frameOffsets[frame].x=offset.x),void 0!==offset.y&&(frameOffsets[frame].y=offset.y)):frameOffsets[frame]=offset}}}});var gifElements=document.querySelectorAll('img[data-src$=".gif"]');for(var e in gifElements){var element=gifElements[e];if("IMG"==element.nodeName){var supergif=new SuperGif({gif:element,progressbar_height:0,auto_play:!1}),controlElement=document.createElement("div");controlElement.className="gifcontrol loading g"+e,supergif.load(function(controlElement){controlElement.className="gifcontrol paused";var playing=!1;controlElement.addEventListener("click",function(){playing?(this.pause(),playing=!1,controlElement.className="gifcontrol paused"):(this.play(),playing=!0,controlElement.className="gifcontrol playing")}.bind(this,controlElement))}.bind(supergif)(controlElement));var canvas=supergif.get_canvas();controlElement.style.width=canvas.width+"px",controlElement.style.height=canvas.height+"px",controlElement.style.left=canvas.offsetLeft+"px";var containerElement=canvas.parentNode;containerElement.appendChild(controlElement)}}